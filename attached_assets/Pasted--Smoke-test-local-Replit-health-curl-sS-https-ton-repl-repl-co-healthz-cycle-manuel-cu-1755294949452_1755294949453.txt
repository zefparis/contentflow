üö¶ Smoke test (local/Replit)
# health
curl -sS https://<ton-repl>.repl.co/healthz

# cycle manuel
curl -XPOST https://<ton-repl>.repl.co/jobs/ingest
curl -XPOST https://<ton-repl>.repl.co/jobs/transform
curl -XPOST https://<ton-repl>.repl.co/jobs/publish


UI: / (dashboard), /assets, /composer, /scheduler, /runs, /reports, /accounts.

üîê .env minimal (prod light)
# DB (upgrade Neon conseill√©)
DATABASE_URL=postgresql+psycopg://USER:PASS@HOST/db?sslmode=require
# S3 (R2/B2)
S3_ENDPOINT=https://<r2-or-b2>
S3_BUCKET=contentflow
S3_ACCESS_KEY=...
S3_SECRET_KEY=...
S3_REGION=auto

APP_BASE_URL=https://<ton-repl>.repl.co
JWT_SECRET=change_me

# YouTube
YOUTUBE_CLIENT_ID=...
YOUTUBE_CLIENT_SECRET=...
YOUTUBE_REDIRECT_URL=${APP_BASE_URL}/oauth/youtube/callback
YOUTUBE_SCOPES=https://www.googleapis.com/auth/youtube.upload

# Reddit
REDDIT_CLIENT_ID=...
REDDIT_CLIENT_SECRET=...
REDDIT_REDIRECT_URL=${APP_BASE_URL}/oauth/reddit/callback
REDDIT_USER_AGENT=contentflow/1.0 by benji
REDDIT_DEFAULT_SUB=videos

# Pinterest
PINTEREST_CLIENT_ID=...
PINTEREST_CLIENT_SECRET=...
PINTEREST_REDIRECT_URL=${APP_BASE_URL}/oauth/pinterest/callback
PINTEREST_BOARD_ID=<board_id>

# (Optionnels / stubs pr√™ts)
IG_APP_ID= IG_APP_SECRET= IG_REDIRECT_URL=${APP_BASE_URL}/oauth/instagram/callback
IG_PAGE_ID= IG_IG_USER_ID=
TIKTOK_CLIENT_KEY= TIKTOK_CLIENT_SECRET= TIKTOK_REDIRECT_URL=${APP_BASE_URL}/oauth/tiktok/callback

# Affiliation
AFFIL_BASE_URL=https://ton-affili√©.tld/landing
AFFIL_DEFAULT_UTM=utm_source={platform}&utm_content={post_id}

üîó OAuth ‚Äì branchement express

YouTube (Shorts)

Google Cloud ‚Üí OAuth client Web ‚Üí autorised redirect = ${APP_BASE_URL}/oauth/youtube/callback

UI: /accounts ‚Üí ‚ÄúConnecter YouTube‚Äù ‚Üí consent ‚Üí done.

Smoke: publie un MP4 < 60s pour √™tre tagg√© ‚ÄúShort‚Äù.

Reddit

reddit.com/prefs/apps ‚Üí ‚Äúweb app‚Äù ‚Üí redirect ${APP_BASE_URL}/oauth/reddit/callback

UI: /accounts ‚Üí connect.

Tips: commence par un sub permissif; set REDDIT_DEFAULT_SUB.

Pinterest

Dev app + token v5 ‚Üí /accounts ‚Üí connect.

Note: si upload renvoie 415 / TUS required, switchera en TUS plus tard (OK pour MVP).

Instagram / TikTok

Graph/TikTok = acc√®s approuv√© (souvent long). Tant que pas valid√© ‚Üí stubs (pas de plantage, juste ‚Äúnon connect√©‚Äù).

üß≤ Ingestion (prod hygiene)

Sources: /sources ‚Üí RSS/YouTube-CC/Stock.

Filtres: keywords CSV, min_duration, lang.

D√©dup: pHash (distance ‚â§ 5 => skip).

Watch: scheduler tourne toutes 30 min (modifiable dans services/scheduler.py).

üéûÔ∏è Transform / FFmpeg

Recipes 9:16, 1080√ó1920, 30fps, faststart.

Overlays: HOOK (0‚Äì5s), CTA (20‚Äì28s), watermark attribution (obligatoire).

SRT optionnel (pas de Whisper local en Replit: either texte‚ÜíSRT ou API externe).

Output ‚Üí S3 (fallback local si S3 non set).

üß† Planner + A/B + Bandit

Planner heuristique ‚Üí quality_score & hashtags.

Composer: g√©n√®re A/B titres/descriptions (2 variantes).

Bandit (Thompson) choisit {platform,lang,hook}; reward = clics (shortlink).

Gate: autopost uniquement si risk < 0.2 ET quality ‚â• 0.7.

üì§ Publishing

YT/Reddit/Pinterest: r√©els (si comptes connect√©s).

IG/TikTok: stubs ‚Äúnon connect√©‚Äù tant que pas d‚Äôacc√®s API.

Backoff + retry (Job.attempts++), log dans /runs.

üí∞ Tracking & revenus

Shortlink /l/{hash} ‚Üí redirige vers AFFIL_BASE_URL + UTM + log MetricEvent(click).

/reports : simulateur ‚Ç¨ (views √ó ctr √ó epc) + export CSV.

KPI journaliers: Views, CTR, EPC, Revenue, par plateforme.

üöÄ Autopilot ‚Äì on/off

Flag (Rule/boolean) dans dashboard.

Cron par d√©faut:

ingest: 30m

transform: 30m

publish: 20m

metrics: 6h

autopilot tick: 10m

Concurrence soft: 1‚Äì2 jobs simultan√©s sur Replit (√©vite throttling).

üßØ Runbook pannes (rapide)

OAuth ‚Äúredirect_mismatch‚Äù ‚Üí v√©rifie ${APP_BASE_URL} et callback exact.

Pinterest 415 ‚Üí OK pour MVP; passera en TUS quand tu veux.

Quota YT 403 ‚Üí ralentis cadence; Shorts < 60s.

FFmpeg fail ‚Üí check logs /runs, essaye d‚Äôabord le clip noir (3s) de d√©mo.

DB locked (SQLite) ‚Üí passe Neon Postgres (fortement recommand√©).

üß™ E2E test (sans creds r√©els)

/jobs/ingest ‚Üí 1+ Asset.new avec keywords.

/jobs/transform ‚Üí MP4 vertical demo + Asset.ready + Post.queued.

/composer ‚Üí set platform=youtube (ou autre) + Cr√©er A/B.

/jobs/publish ‚Üí ‚Äúposted‚Äù (si compte connect√©) ou ‚Äúfailed non connect√©‚Äù (stub).

/l/{hash} ‚Üí redirige + MetricEvent(click) visible dans /reports.

üîí Hygiene anti-ban (rappel)

CC-BY/stock only, attribution visible.

#ad si affiliation.

Rate-limit + jitter, variation titres/descr.

Pas de scraping ‚Äúsale‚Äù.